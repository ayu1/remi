---
title: "HNSCC_caberNET"
output: html_document
---

```{r setup, include=FALSE}
library(remi)
if (!(requireNamespace("org.Hs.eg.db", quietly = TRUE))) {
  BiocManager::install("org.Hs.eg.db")
}
if (!(requireNamespace("clusterProfiler", quietly = TRUE))) {
  BiocManager::install("clusterProfiler")
}
```

Read in HNSCC scRNA-seq atlas, rename cell types for consistency
```{r}
HNSCC <- readRDS("~/Projects/rotation_remi/data/test/scRNA/HNSCC_subpopulationclusters.rds")

HNSCC.metadata <- data.frame(HNSCC@meta.data, stringsAsFactors = F)
HNSCC.metadata$cell_subset <- gsub("Malignant cells", "Malignant", HNSCC.metadata$cell_subset)
HNSCC.metadata$cell_subset <- gsub("Fibroblasts", "Fibroblast", HNSCC.metadata$cell_subset)
HNSCC.metadata$cell_subset <- gsub("Endothelial cells", "Endothelial", HNSCC.metadata$cell_subset)
HNSCC.metadata$cell_subset <- gsub("T cells", "T cell", HNSCC.metadata$cell_subset)

HNSCC <- AddMetaData(HNSCC, HNSCC.metadata)

primary.HNSCC <- subset(HNSCC, location == "Primary")
met.HNSCC <- subset(HNSCC, location == "Met")
```

Function to average expression levels for each gene across cell-types
```{r}
SingleToBulk <- function(obj, assay) {
  temp.rownames <- rownames(obj@meta.data)
  obj@meta.data <- obj@meta.data %>% 
    mutate(group.ctype = paste0(sample, "_" , cell_type))
  rownames(obj@meta.data) <- temp.rownames
  
  Idents(obj) <- "group.ctype"
  avg.obj <- AverageExpression(obj, return.seurat=T, assays=assay) 
  avg.dat <- GetAssayData(avg.obj, "data") %>% as.matrix

  avg.dat[is.na(avg.dat)] <- 0
  
  avg.scaled <- t(scale(t(avg.dat)))
  avg.scaled <- na.omit(avg.scaled)
  
  cellmarkers <- unique(unlist(lapply(colnames(avg.scaled), 
                                      function(x) {strsplit(x, "_")[[1]][2]})))
  names(cellmarkers) <- cellmarkers
  
  return(list(scaleddat=avg.scaled, dat=avg.dat, cellmarkers=cellmarkers))
}
```

Determine whether or not all cell-types are present across all samples
```{r}
setupSingleCell <- function(obj, celltype.col, remove.markers=c(), gene.select = NULL, 
                            assay="integrated", filter=T, thres=0) {
  pseudobulk <- SingleToBulk(obj, assay) 
  
  num.markers <- length(pseudobulk$cellmarkers) - length(remove.markers)
  
  filtered.cellexps <- list()
  notfiltered.cellexps <- list()
  
  colsvec <- c()
  for(i in 1:length(pseudobulk$cellmarkers)) {
    curr.name <- pseudobulk$cellmarkers[i]
    if(!(curr.name %in% remove.markers)) {
  
      nospace.name <- as.character(gsub(" ", "", curr.name))
      
      all.cols <- unlist(lapply(colnames(pseudobulk$dat), 
                                function(x) {strsplit(x, "_")[[1]][2]}))
      all.cols <- gsub(" ", "", all.cols)
      
      cell.cols <- grep(paste0("\\b", nospace.name, "\\b"), all.cols)
      celltype.filt <- pseudobulk$dat[,cell.cols]
  
      # Match sample name 
      dat.cols <- unlist(lapply(colnames(celltype.filt), 
                                function(x) {strsplit(x, "_")[[1]][1]}))
      
      colsvec <- c(colsvec, dat.cols)
      
      # Removing genes with low expression
      removegenes <- rownames(celltype.filt)[which(rowMeans(celltype.filt) <= thres)]
      
      # Finalized cleaned data matrix
      cleaned.filt <- pseudobulk$scaleddat[-which(rownames(pseudobulk$scaleddat) %in% removegenes),cell.cols]
      
      # Adding in cell type into rownames
      rownames(celltype.filt) <- paste0(curr.name, "_", rownames(celltype.filt))
      colnames(celltype.filt) <- dat.cols
      
      rownames(cleaned.filt) <- paste0(curr.name, "_", rownames(cleaned.filt))
      colnames(cleaned.filt) <- dat.cols
      
      if(is.null(gene.select)) {
        print(dim(cleaned.filt))
        filtered.cellexps[[curr.name]] <- cleaned.filt
        notfiltered.cellexps[[curr.name]] <- celltype.filt   
      } else {
        filtered.cellexps[[curr.name]] <- cleaned.filt[which(rownames(cleaned.filt) %in% gene.select),]
        notfiltered.cellexps[[curr.name]] <- celltype.filt[which(rownames(celltype.filt) %in% gene.select),]
      }   
    }
  }

  allpresent.cols <- names(which(table(colsvec) == num.markers))

  #Filtering non-filtered data
  for(c in names(notfiltered.cellexps)) {
    allpresent.filt.data <- notfiltered.cellexps[[c]][,which(colnames(notfiltered.cellexps[[c]]) %in% allpresent.cols)]
    
    duplicate.cols <- which(apply(allpresent.filt.data, 1,
                                  function(x) length(unique(x))==1) == TRUE)
    if(length(duplicate.cols) > 0) {
      notfiltered.cellexps[[c]] <- allpresent.filt.data[-duplicate.cols,]
    } else {
      notfiltered.cellexps[[c]] <- allpresent.filt.data
    }
  }
  
  # Only using samples that have all the cell types of interest
  for(c in names(filtered.cellexps)) {
    allpresent.filt.data <- filtered.cellexps[[c]][,allpresent.cols]
    duplicate.cols <- which(apply(allpresent.filt.data, 1, 
                                  function(x) length(unique(x))==1) == TRUE)
    if(length(duplicate.cols) > 0) {
      filtered.cellexps[[c]] <- allpresent.filt.data[-duplicate.cols,]
    } else {
      filtered.cellexps[[c]] <- allpresent.filt.data
    }
  }
  
  if(filter == F) {
    return(list(filtered=notfiltered.cellexps, unfiltered=notfiltered.cellexps, cellmarkers=pseudobulk$cellmarkers))
  } else {
    return(list(filtered=filtered.cellexps, unfiltered=notfiltered.cellexps, cellmarkers=pseudobulk$cellmarkers))
  }
}
```

Calculating average expression for primary, LN, combined
# Removed mast cells from Met list because only two samples had all cell types
```{r}
#subset.cells <- c("T cell", "Endothelial", "Fibroblast", "Malignant")
#primary.subset.HNSCC <- subset(primary.HNSCC, cell_subset %in% subset.cells)
#met.subset.HNSCC <- subset(met.HNSCC, cell_subset %in% subset.cells)
primary.bulk <- setupSingleCell(primary.HNSCC, "cell_type", 
                                #gene.select = prim.intersect.genes,
                                thres=0.5)
met.bulk <- setupSingleCell(met.HNSCC, 
                            celltype.col = "cell_subset",
                            remove.markers = c("Mast cells"),
                            #gene.select=ln.intersect.genes, 
                            thres=0.5)

all.bulk <- setupSingleCell(HNSCC, 
                            celltype.col = "cell_type",
                            remove.markers = c("Mast cells"),
                            #gene.select=ln.intersect.genes, 
                            thres=0.5)
```

```{r}
saveRDS(primary.bulk, file="prim_bulk_thres05.rds")
saveRDS(met.bulk, file="met_bulk_thres05.rds")
saveRDS(all.bulk, file="all_bulk_thres05.rds")
```

```{r}
primary.bulk <- readRDS("prim_bulk_thres05.rds")
met.bulk <- readRDS("met_bulk_thres05.rds")
all.bulk <- readRDS("all_bulk_thres05.rds")
```

Running REMI on HNSCC atlas
```{r}
hnscc.remi <- remi(all.bulk$cellmarkers, all.bulk, cd="Louvain")
```

